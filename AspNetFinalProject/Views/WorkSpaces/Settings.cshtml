@inject ICurrentUserService CurrentUserService
@using AspNetFinalProject.Enums
@using AspNetFinalProject.Services.Interfaces
@model AspNetFinalProject.DTOs.WorkSpaceDto
@{
    ViewData["Title"] = Model.Title;
    ViewData["AdminRights"] = await CurrentUserService.HasWorkspaceRoleAsync(
        Guid.Parse(Model.Id), 
        ParticipantRole.Admin, ParticipantRole.Owner);

    ViewData["MemberRights"] = (bool?)ViewData["AdminRights"] == true || await CurrentUserService.HasWorkspaceRoleAsync(
        Guid.Parse(Model.Id),
        ParticipantRole.Member);
    ViewData["ParticipantRights"] = (bool?)ViewData["MemberRights"] == true || await CurrentUserService.HasWorkspaceRoleAsync(
        Guid.Parse(Model.Id),
        ParticipantRole.Viewer);
}

<h2>Налаштування: @Model.Title</h2>

<ul class="nav nav-tabs mb-3" id="settingsTabs">
    <li class="nav-item">
        <a class="nav-link active" data-action="open-tab" data-tab="general" href="#">Загальні</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-action="open-tab" data-tab="boards" href="#">Дошки</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-action="open-tab" data-tab="participants" href="#">Учасники</a>
    </li>
</ul>

<div id="tabContent">
    <div data-tab-content="general" id="tab-general">
        <form data-action="update-workspace-form" id="workspaceSettingsForm">
            <div class="mb-3">
                <label class="form-label">Назва</label>
                <input @((bool?)ViewData["AdminRights"] == true ? "" : "disabled") type="text" maxlength="100" minlength="3" class="form-control" name="title" value="@Model.Title">
            </div>
            <div class="mb-3">
                <label class="form-label">Опис</label>
                <textarea @((bool?)ViewData["AdminRights"] == true ? "" : "disabled") class="form-control" maxlength="1000" name="description">@Model.Description</textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Видимість</label>
                <select disabled="@( (bool?)ViewData["AdminRights"] != true )" class="form-select" name="visibility" asp-for="Visibility"
                        asp-items="Html.GetEnumSelectList<WorkSpaceVisibility>()">
                </select>
            </div>
            @{
                if ((bool?)ViewData["AdminRights"] == true)
                {
                    <button type="submit" class="btn btn-primary">
                        Зберегти
                    </button>
                }
            }
        </form>
        
        @{
            if ((bool?)ViewData["ParticipantRights"] == true)
            {
            <button class="btn btn-sm @(Model.IsSubscribed ? "btn-danger" : "btn-success")"
                    data-id="@Model.Id"
                    data-action="subscribe-workspace"
                    data-subscribed="@Model.IsSubscribed"
                    id="subscribe-btn">
                @(Model.IsSubscribed ? "Відписатися" : "Підписатися")
            </button>
            }
        }
        
        @{
            if ((bool?)ViewData["AdminRights"] == true)
            {
                <button class="btn btn-sm btn-danger ms-2"
                        id="delete-btn"
                        data-id="@Model.Id"
                        data-action="delete-workspace"
                        data-title="@Model.Title">🗑</button>
            }
        }
    </div>

    <div data-tab-content="boards" id="tab-boards" class="d-none">
        @{
            if ((bool?)ViewData["MemberRights"] == true)
            {
                <button class="btn btn-primary mt-3 w-100" data-bs-toggle="modal" data-bs-target="#createBoardModal">
                    Create Board
                </button>
            }
        }
        <div class="col-md-6">
            <h5 class="mb-2">Дошки</h5>
            <div>
                <div id="boards-list" class="vstack gap-2">
                    <!-- тут з’являться картки дошок -->
                </div>
            </div>
        </div>
    </div>
    <div data-tab-content="participants" id="tab-participants" class="d-none">
        <div class="row g-3">
            <div class="col-md-6">
                <h5 class="mb-2">Учасники</h5>
                <div>
                    <div id="participants-list" class="vstack gap-2">
                        <!-- тут з’являться картки учасників -->
                    </div>
                </div>
            </div>

            @{
                if ((bool?)ViewData["AdminRights"] == true)
                {
                    <div class="col-md-6">
                        <h5 class="mb-2">Додати учасника</h5>
                        <div class="mb-2">
                            <input data-action="search-participant-input" id="participant-search" class="form-control" placeholder="Введи нік або email" autocomplete="off">
                        </div>
                        <div data-participants-search-results id="participant-search-results" class="vstack gap-2">
                            <!-- тут з’являться результати пошуку -->
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@await Html.PartialAsync("_ConfirmDeleteModal")
@await Html.PartialAsync("_CreateBoardModal")




@section Scripts {
    <script>
        window.workspace = @Html.Raw(Json.Serialize(Model));
    </script>
    <script type="module" src="~/js/features/workspaces/settings/main.js"></script>
}